openapi: 3.0.0
info:
  title: TrimSKUOpener API
  version: 1.0.0
  description: Excel verilerini okuyup PLM sistemine TrimSKU yazan ve barkod atayan API
  contact:
    name: API Support

servers:
  - url: https://trimskuopener-4b8505224c7d.herokuapp.com
    description: Production server (Heroku)
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Home
    description: Ana sayfa endpoints
  - name: Health Check
    description: Sağlık kontrolü endpoints
  - name: Excel Processing
    description: Excel işleme ve PLM entegrasyonu
  - name: XML Processing
    description: XML ile Excel işleme ve PLM entegrasyonu
  - name: Async Processing
    description: Async (Worker Dyno) ile işleme - Production için (1000+ satır)

paths:
  /:
    get:
      summary: Ana Sayfa
      description: API ana sayfası - Swagger dokümantasyonuna yönlendirir
      tags:
        - Home
      responses:
        '200':
          description: API bilgileri
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: TrimSKUOpener API - Excel to PLM Data Processor
                  version:
                    type: string
                    example: "1.0.0"
                  documentation:
                    type: string
                    example: /api-docs
                  swagger:
                    type: string
                    example: https://trimskuopener-4b8505224c7d.herokuapp.com/api-docs

  /api/health:
    get:
      summary: Sağlık Kontrolü
      description: API'nin çalışır durumda olup olmadığını kontrol eder
      tags:
        - Health Check
      responses:
        '200':
          description: API çalışıyor
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: API çalışıyor
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-11-10T14:30:00.000Z"

  /api/process-and-write-to-plm:
    post:
      summary: Excel'den PLM'e Tam İşlem
      description: |
        Excel dosyasını URL'den okur, validasyon yapar, PLM ile eşleştirir, TrimSKU yaratır, SKU ID'lerini çeker ve barkodları atar.
        
        **İşlem Adımları:**
        1. Excel URL'den okunur
        2. Başlık ve zorunlu alan validasyonu yapılır
        3. PLM ile eşleştirme (Trim/Renk/Beden → ID'ler)
        4. PLM'e TrimSKU yaratılır
        5. Yaratılan SKU'ların ID'leri çekilir
        6. Excel satırları SKU ID'leri ile eşleştirilir
        7. Her SKU'ya barkod atanır
        
        **Excel Formatı (Zorunlu Başlıklar):**
        - `Trim Kodu` (Zorunlu)
        - `Renk Kodu` (Zorunlu)
        - `Beden Kodu` (Opsiyonel)
        - `YeniEge Barkod` (Zorunlu)
      tags:
        - Excel Processing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExcelRequest'
            examples:
              example1:
                summary: Örnek Excel URL
                value:
                  url: "https://idm.eu1.inforcloudsuite.com/ca/api/resources/FPLM_Document-90028-2-LATEST?$token=..."
      responses:
        '200':
          description: İşlem başarılı
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success:
                  summary: Başarılı İşlem
                  value:
                    success: true
                    message: "Excel verisi başarıyla işlendi, PLM'e yazıldı, SKU ID'leri alındı ve barkodlar atandı"
                    data:
                      excel:
                        totalRows: 9
                        processedRows: 9
                      plm:
                        totalTrims: 1
                        successfulTrims: 1
                        failedTrims: 0
                        results:
                          - trimId: 1558
                            trimCode: "TRFED00069"
                            skuCount: 9
                      skus:
                        totalSKUs: 37
                        matchedRows: 9
                      barcodes:
                        total: 9
                        successful: 9
                        failed: 0
        '400':
          description: Validasyon hatası veya eksik bilgi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingHeaders:
                  summary: Eksik Başlık Hatası
                  value:
                    success: false
                    message: "Eksik başlık"
                    missingHeaders: ["Trim Kodu"]
                emptyFields:
                  summary: Boş Alan Hatası
                  value:
                    success: false
                    message: "Lütfen eksik bilgileri doldurunuz"
                    errors:
                      - row: 2
                        emptyFields: ["Trim Kodu", "Renk Kodu"]
        '500':
          description: Sunucu hatası
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                serverError:
                  summary: Sunucu Hatası
                  value:
                    success: false
                    message: "İşlem sırasında bir hata oluştu"
                    error: "Request failed with status code 500"

  /api/process-xml:
    post:
      summary: XML'den PLM'e Tam İşlem
      description: |
        PLM'den gelen XML'i parse eder, içinden ItemID ve DocumentType çıkarır, PLM Document API ile gerçek Excel URL'ini alır ve normal Excel işleme flow'unu çalıştırır.
        
        **İşlem Adımları:**
        1. XML parse edilir
        2. AlternateDocumentID'den ITEMID çıkarılır (örn: /TrimBarcode[@ITEMID = "2"] → "2")
        3. DocumentTypeID alınır (örn: "TrimBarcode")
        4. PLM Document API ile gerçek Excel URL'i alınır
        5. Excel URL'den okunur
        6. Başlık ve zorunlu alan validasyonu yapılır
        7. PLM ile eşleştirme (Trim/Renk/Beden → ID'ler)
        8. PLM'e TrimSKU yaratılır
        9. Yaratılan SKU'ların ID'leri çekilir
        10. Excel satırları SKU ID'leri ile eşleştirilir
        11. Her SKU'ya barkod atanır
        
        **XML Formatı:**
        - `SyncContentDocument` root element
        - `AlternateDocumentID/ID`: ITEMID içerir
        - `DocumentMetaData/DocumentTypeID`: Document type (örn: TrimBarcode)
        
        **Excel Formatı (Zorunlu Başlıklar):**
        - `Trim Kodu` (Zorunlu)
        - `Renk Kodu` (Zorunlu)
        - `Beden Kodu` (Opsiyonel)
        - `YeniEge Barkod` (Zorunlu)
      tags:
        - XML Processing
      requestBody:
        required: true
        content:
          application/xml:
            schema:
              type: string
              example: |
                <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                <SyncContentDocument xmlns="http://schema.infor.com/InforOAGIS/2">
                  <ApplicationArea>
                    <Sender>
                      <LogicalID>lid://infor.daf.daf</LogicalID>
                    </Sender>
                    <CreationDateTime>2025-11-17T06:15:44.698Z</CreationDateTime>
                  </ApplicationArea>
                  <DataArea>
                    <Sync>
                      <ActionCriteria>
                        <ActionExpression actionCode="Add"/>
                      </ActionCriteria>
                    </Sync>
                    <ContentDocument>
                      <DocumentID>
                        <ID variationID="1763360144691">TrimBarcode-2-0-LATEST</ID>
                      </DocumentID>
                      <AlternateDocumentID>
                        <ID>/TrimBarcode[@ITEMID = "2"]</ID>
                      </AlternateDocumentID>
                      <DocumentMetaData>
                        <DocumentTypeID>TrimBarcode</DocumentTypeID>
                      </DocumentMetaData>
                    </ContentDocument>
                  </DataArea>
                </SyncContentDocument>
      responses:
        '200':
          description: İşlem başarılı
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "XML işleme ve PLM yazma işlemi başarıyla tamamlandı"
                  xmlInfo:
                    type: object
                    properties:
                      itemId:
                        type: string
                        example: "2"
                        description: XML'den çıkarılan Item ID
                      docType:
                        type: string
                        example: "TrimBarcode"
                        description: XML'den çıkarılan Document Type
                      filename:
                        type: string
                        example: "TrimUpt.xlsx"
                        description: Excel dosya adı
                      documentKey:
                        type: string
                        example: "TrimBarcode-2-1-LATEST"
                        description: PLM Document Key
                  summary:
                    type: object
                    properties:
                      totalRows:
                        type: integer
                        example: 9
                        description: Excel'deki toplam satır sayısı
                      matchedRows:
                        type: integer
                        example: 9
                        description: PLM ile eşleştirilen satır sayısı
                      unmatchedRows:
                        type: integer
                        example: 0
                        description: Eşleştirilememiş satır sayısı
                      createdSKUs:
                        type: integer
                        example: 9
                        description: Yaratılan SKU sayısı
                      failedSKUs:
                        type: integer
                        example: 0
                        description: Hatalı SKU sayısı
                      assignedBarcodes:
                        type: integer
                        example: 9
                        description: Atanan barkod sayısı
                      failedBarcodes:
                        type: integer
                        example: 0
                        description: Hatalı barkod sayısı
                  details:
                    type: object
                    description: Detaylı işlem sonuçları
        '400':
          description: Validasyon hatası veya eksik bilgi
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Geçersiz XML formatı"
                  details:
                    type: string
                    example: "AlternateDocumentID bulunamadı"
              examples:
                invalidXml:
                  summary: Geçersiz XML
                  value:
                    success: false
                    error: "Geçersiz XML formatı"
                    details: "XML parse hatası"
                missingItemId:
                  summary: ITEMID Bulunamadı
                  value:
                    success: false
                    error: "ITEMID AlternateDocumentID içinde bulunamadı"
                    alternateDocId: "/TrimBarcode"
                missingHeaders:
                  summary: Eksik Excel Başlığı
                  value:
                    success: false
                    error: "Eksik başlık(lar) tespit edildi"
                    missingHeaders: ["Trim Kodu"]
                emptyFields:
                  summary: Boş Zorunlu Alan
                  value:
                    success: false
                    error: "Lütfen eksik bilgileri doldurunuz"
                    emptyFieldRows:
                      - row: 2
                        emptyFields: ["Trim Kodu"]
        '500':
          description: Sunucu hatası
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Document URL alınamadı"
                  details:
                    type: string
                    example: "Request failed with status code 500"
              examples:
                documentError:
                  summary: Document URL Hatası
                  value:
                    success: false
                    error: "Document URL alınamadı"
                    details: "Token alınamadı"
                plmError:
                  summary: PLM İşlem Hatası
                  value:
                    success: false
                    error: "PLM eşleştirme hatası"
                    details: "Request failed with status code 500"

components:
  schemas:
    ExcelRequest:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: Excel dosyasının URL'si (token içerebilir)
          example: "https://idm.eu1.inforcloudsuite.com/ca/api/resources/FPLM_Document-90028-2-LATEST?$token=..."

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Excel verisi başarıyla işlendi, PLM'e yazıldı, SKU ID'leri alındı ve barkodlar atandı"
        data:
          type: object
          properties:
            excel:
              type: object
              properties:
                totalRows:
                  type: integer
                  example: 9
                  description: Excel'deki toplam satır sayısı
                processedRows:
                  type: integer
                  example: 9
                  description: İşlenen satır sayısı
            plm:
              type: object
              properties:
                totalTrims:
                  type: integer
                  example: 1
                  description: İşlenen toplam Trim sayısı
                successfulTrims:
                  type: integer
                  example: 1
                  description: Başarıyla yazılan Trim sayısı
                failedTrims:
                  type: integer
                  example: 0
                  description: Hatalı Trim sayısı
                results:
                  type: array
                  items:
                    type: object
                    properties:
                      trimId:
                        type: integer
                        example: 1558
                      trimCode:
                        type: string
                        example: "TRFED00069"
                      skuCount:
                        type: integer
                        example: 9
                        description: Bu Trim için yaratılan SKU sayısı
            skus:
              type: object
              properties:
                totalSKUs:
                  type: integer
                  example: 37
                  description: PLM'de bulunan toplam SKU sayısı
                matchedRows:
                  type: integer
                  example: 9
                  description: Excel ile eşleştirilen SKU sayısı
                data:
                  type: array
                  items:
                    type: object
                    properties:
                      rowNumber:
                        type: integer
                        example: 2
                      excelData:
                        type: object
                        properties:
                          trimCode:
                            type: string
                            example: "TRFED00069"
                          colorCode:
                            type: string
                            example: "039TY"
                          sizeCode:
                            type: string
                            example: "10.5cm"
                          barcode:
                            type: string
                            example: "YeniEge1"
                      plmData:
                        type: object
                        properties:
                          trimId:
                            type: integer
                            example: 1558
                          trimColorwayId:
                            type: integer
                            example: 7680
                          sizeId:
                            type: integer
                            example: 118
                          skuId:
                            type: integer
                            example: 76
                            description: Yaratılan SKU'nun ID'si
            barcodes:
              type: object
              properties:
                total:
                  type: integer
                  example: 9
                  description: Toplam barkod atama sayısı
                successful:
                  type: integer
                  example: 9
                  description: Başarılı barkod atama sayısı
                failed:
                  type: integer
                  example: 0
                  description: Hatalı barkod atama sayısı
                results:
                  type: array
                  items:
                    type: object
                    properties:
                      rowNumber:
                        type: integer
                        example: 2
                      skuId:
                        type: integer
                        example: 76
                      barcode:
                        type: string
                        example: "YeniEge1"
                      status:
                        type: string
                        enum: [success, failed]
                        example: success

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "İşlem sırasında bir hata oluştu"
        error:
          type: string
          example: "Hata detayı"
        missingHeaders:
          type: array
          items:
            type: string
          description: Eksik başlıklar (validasyon hatası durumunda)
        errors:
          type: array
          items:
            type: object
            properties:
              row:
                type: integer
                description: Hatalı satır numarası
              emptyFields:
                type: array
                items:
                  type: string
                description: Boş olan zorunlu alanlar
          description: Detaylı hata listesi (validasyon hatası durumunda)

  /api/process-xml-async:
    post:
      summary: XML İşleme (ASYNC - Production için)
      description: |
        **ASYNC İŞLEM - WORKER DYNO İLE ÇALIŞIR**
        
        XML verisi ile Excel URL'i alır, job oluşturur ve hemen 202 Accepted döner.
        İşlem arka planda Worker Dyno tarafından gerçekleştirilir.
        
        **Kullanım:**
        1. Bu endpoint'e XML gönder
        2. 202 Accepted + jobId al
        3. `/api/job-status/:jobId` ile durumu kontrol et
        
        **Avantajlar:**
        - ✅ 1000+ satırlık listeler işlenebilir
        - ✅ 4-5 dakikalık işlemler timeout olmaz
        - ✅ Production-ready
        
        **Gereksinimler:**
        - ✅ Heroku Postgres (DATABASE_URL)
        - ✅ Worker Dyno (`heroku ps:scale worker=1`)
      tags:
        - Async Processing
      requestBody:
        required: true
        content:
          application/xml:
            schema:
              type: string
              example: |
                <DocumentRevisionUpdate>
                  <AlternateDocumentID>TYPE="ITEMS", ITEMID="2"</AlternateDocumentID>
                  <DocumentMetaData>
                    <DocumentTypeID>TrimBarcode</DocumentTypeID>
                  </DocumentMetaData>
                </DocumentRevisionUpdate>
      responses:
        '202':
          description: İşlem alındı, arka planda işleniyor
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "İşlem alındı, arka planda işleniyor"
                  jobId:
                    type: string
                    example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                  statusUrl:
                    type: string
                    example: "/api/job-status/a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                  estimatedTime:
                    type: string
                    example: "2-5 dakika"
        '400':
          description: Hatalı istek
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Sunucu hatası
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/job-status/{jobId}:
    get:
      summary: Job Durumu Sorgula
      description: |
        Async işleme gönderilen job'un durumunu sorgular.
        
        **Status Değerleri:**
        - `pending`: İşlem bekliyor (worker henüz almadı)
        - `processing`: İşlem devam ediyor
        - `completed`: İşlem tamamlandı
        - `failed`: İşlem başarısız
        
        **Polling:** 
        PLM tarafından 5-10 saniyede bir kontrol edilmeli.
      tags:
        - Async Processing
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
          description: Job ID (process-xml-async'den dönen)
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        '200':
          description: Job durumu
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    description: Pending status
                    properties:
                      success:
                        type: boolean
                        example: true
                      jobId:
                        type: string
                      status:
                        type: string
                        example: "pending"
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
                  - type: object
                    description: Processing status
                    properties:
                      success:
                        type: boolean
                        example: true
                      jobId:
                        type: string
                      status:
                        type: string
                        example: "processing"
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
                      progress:
                        type: object
                        properties:
                          totalRows:
                            type: integer
                            example: 1000
                          processedRows:
                            type: integer
                            example: 450
                          currentStep:
                            type: string
                            example: "Barkodlar atanıyor... (450/1000)"
                  - type: object
                    description: Completed status
                    properties:
                      success:
                        type: boolean
                        example: true
                      jobId:
                        type: string
                      status:
                        type: string
                        example: "completed"
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
                      completedAt:
                        type: string
                        format: date-time
                      result:
                        type: object
                        description: İşlem sonucu (process-xml response'u ile aynı)
                  - type: object
                    description: Failed status
                    properties:
                      success:
                        type: boolean
                        example: true
                      jobId:
                        type: string
                      status:
                        type: string
                        example: "failed"
                      createdAt:
                        type: string
                        format: date-time
                      updatedAt:
                        type: string
                        format: date-time
                      error:
                        type: string
                        example: "PLM eşleştirme hatası: Trim kodu bulunamadı"
        '404':
          description: Job bulunamadı
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Job bulunamadı"
                  jobId:
                    type: string
        '500':
          description: Sunucu hatası
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

